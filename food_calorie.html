<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Food Calorie Estimator — FitJourney</title>

<link rel="stylesheet" href="style.css"> <!-- optional if you have a shared stylesheet -->

<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f7f9;margin:0;padding:18px;color:#222}
  .page{max-width:760px;margin:auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  h1{color:#2e7d32;margin:6px 0 14px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input[type=file]{display:block;margin:12px 0}
  img.preview{max-width:320px;border-radius:10px;display:block;margin:12px 0;border:1px solid #ddd}
  .results{margin-top:12px;padding:12px;border-radius:8px;background:#f9fff9}
  label{display:block;margin-top:8px;font-weight:600}
  select,input[type=number],input[type=text]{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
  .small{max-width:200px}
  button{background:#43a047;color:white;border:none;padding:12px 16px;border-radius:8px;font-weight:700;cursor:pointer;margin-top:10px}
  .muted{color:#666;font-size:14px}
  .warning{color:#b33;margin-top:8px}
</style>
</head>
<body>
<div class="page">
  <h1>Food Photo → Nutrition Estimate</h1>
  <p class="muted">Take a photo of your meal (or pick from library). The model will suggest the food; confirm it and enter portion size for an estimated calories/protein/fat result.</p>

  <label for="file">Take or upload a photo</label>
  <input id="file" type="file" accept="image/*" capture="environment">

  <img id="preview" class="preview" alt="Food preview" />

  <div id="status" class="muted">Model not loaded yet — give it a moment after first use.</div>

  <div id="suggestArea" style="display:none">
    <label>Model suggestion</label>
    <div id="suggestion" style="font-weight:700; margin:6px 0"></div>

    <label>Or choose a food (if suggestion is wrong)</label>
    <select id="foodSelect"></select>

    <label>Portion size</label>
    <div class="row">
      <input id="grams" type="number" placeholder="Grams (e.g. 150)" min="1" class="small">
      <input id="servings" type="number" placeholder="Servings (optional, e.g. 1)" min="0.01" step="0.01" class="small">
    </div>

    <button id="calcBtn">Calculate Nutrition</button>

    <div id="out" class="results" style="display:none"></div>
  </div>

  <p class="muted">Note: this gives an <strong>estimate</strong>. For medical advice or exact tracking use a dedicated food scale and verified database.</p>
</div>

<!-- TFJS + MobileNet -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.2.2/dist/mobilenet.min.js"></script>

<script>
/*
  Approach:
  1) Load mobilenet (client-side). Classify uploaded image -> top label(s).
  2) Map label to a canonical food name via fuzzy matching or fallback to a dropdown.
  3) Use a small local nutrition database (values per 100 g).
  4) User enters grams (or servings), we compute calories/protein/fat.
*/

/* --- Nutrition lookup (approx per 100 g) ---
   Values are approximate averages. Modify/add items as you like.
*/
const NUTRITION_DB = {
  "apple": {cal:52, protein:0.3, fat:0.2},
  "banana": {cal:89, protein:1.1, fat:0.3},
  "chicken breast (cooked)": {cal:165, protein:31, fat:3.6},
  "rice (white, cooked)": {cal:130, protein:2.4, fat:0.3},
  "bread (slice)": {cal:265, protein:9, fat:3.2}, // per 100 g (avg)
  "egg (whole, cooked)": {cal:155, protein:13, fat:11},
  "salmon (cooked)": {cal:208, protein:20, fat:13},
  "beef (ground, cooked)": {cal:250, protein:26, fat:15},
  "potato (boiled)": {cal:87, protein:1.9, fat:0.1},
  "avocado": {cal:160, protein:2, fat:15},
  "plain yogurt": {cal:59, protein:10, fat:0.4},
  "milk (whole)": {cal:60, protein:3.2, fat:3.3},
  "cheddar cheese": {cal:403, protein:25, fat:33},
  "almonds": {cal:579, protein:21, fat:50},
  "peanut butter": {cal:588, protein:25, fat:50},
  "pasta (cooked)": {cal:131, protein:5, fat:1.1},
  "oats (raw)": {cal:389, protein:17, fat:7},
  "broccoli (raw)": {cal:34, protein:2.8, fat:0.4},
  "spinach (raw)": {cal:23, protein:2.9, fat:0.4},
  "beans (cooked)": {cal:127, protein:9, fat:0.5},
  "tofu (firm)": {cal:76, protein:8, fat:4.8},
  "unknown": {cal:0, protein:0, fat:0}
};

/* Build a list for dropdown sorted alphabetically */
const FOOD_LIST = Object.keys(NUTRITION_DB).filter(k => k !== "unknown").sort();

/* Helper: try to map model label to db food names */
function mapLabelToFood(label){
  label = label.toLowerCase();
  // direct matches
  for(const key of FOOD_LIST){
    if(label.includes(key.split(" ")[0])) return key;
    // check if key contains a single word present in label
    const first = key.split(" ")[0];
    if(label.includes(first)) return key;
  }
  // some custom heuristics
  if(label.includes("banana")) return "banana";
  if(label.includes("apple")) return "apple";
  if(label.includes("chicken")) return "chicken breast (cooked)";
  if(label.includes("rice")) return "rice (white, cooked)";
  if(label.includes("egg")) return "egg (whole, cooked)";
  if(label.includes("salmon")||label.includes("fish")) return "salmon (cooked)";
  if(label.includes("potato")||label.includes("fries")) return "potato (boiled)";
  if(label.includes("avocado")) return "avocado";
  if(label.includes("almond")) return "almonds";
  if(label.includes("peanut")) return "peanut butter";
  if(label.includes("oat")) return "oats (raw)";
  if(label.includes("pasta")) return "pasta (cooked)";
  if(label.includes("broccoli")) return "broccoli (raw)";
  if(label.includes("spinach")) return "spinach (raw)";
  if(label.includes("tofu")) return "tofu (firm)";
  if(label.includes("cheese")) return "cheddar cheese";
  if(label.includes("yogurt")) return "plain yogurt";
  if(label.includes("banana")) return "banana";
  return null;
}

/* UI elements */
const fileInput = document.getElementById('file');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
const suggestionBox = document.getElementById('suggestArea');
const suggestionText = document.getElementById('suggestion');
const foodSelect = document.getElementById('foodSelect');
const gramsInput = document.getElementById('grams');
const servingsInput = document.getElementById('servings');
const calcBtn = document.getElementById('calcBtn');
const out = document.getElementById('out');

let model = null;

/* populate dropdown */
function populateDropdown(){
  foodSelect.innerHTML = '';
  FOOD_LIST.forEach(f=>{
    const opt = document.createElement('option');
    opt.value = f;
    opt.textContent = f;
    foodSelect.appendChild(opt);
  });
}
populateDropdown();

/* Load the model on page load */
(async function loadModel(){
  status.textContent = "Loading image model — please wait...";
  try{
    model = await mobilenet.load();
    status.textContent = "Model ready. Take a photo of your food.";
  }catch(err){
    console.error(err);
    status.textContent = "Model failed to load. Check your internet connection.";
  }
})();

/* When user selects an image */
fileInput.addEventListener('change', async (ev) => {
  out.style.display = 'none';
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  preview.src = url;
  preview.style.display = 'block';
  status.textContent = "Classifying image...";
  // wait for image to load into DOM
  await new Promise(r => preview.onload = r);
  if(!model){
    status.textContent = "Model not loaded yet — please wait and try again.";
    return;
  }
  try{
    const predictions = await model.classify(preview, 5);
    console.log('predictions', predictions);
    const top = predictions[0];
    status.textContent = `Model thinks: ${top.className} (confidence ${Math.round(top.probability*100)}%)`;
    // get a food mapping
    const mapped = mapLabelToFood(top.className);
    suggestionText.textContent = top.className;
    if(mapped){
      proposeFood(mapped);
    } else {
      // show dropdown with default selection (user picks)
      suggestionBox.style.display = 'block';
      foodSelect.selectedIndex = 0;
    }
  }catch(err){
    console.error(err);
    status.textContent = "Failed to classify image.";
  }
});

/* propose a mapped food */
function proposeFood(foodKey){
  suggestionBox.style.display = 'block';
  // set dropdown selection if present
  let foundIndex = FOOD_LIST.indexOf(foodKey);
  if(foundIndex >= 0) foodSelect.selectedIndex = foundIndex;
  else foodSelect.selectedIndex = 0;
}

/* Calculation handler */
calcBtn.addEventListener('click', ()=>{
  const selected = foodSelect.value || FOOD_LIST[0];
  const grams = Number(gramsInput.value);
  const servings = Number(servingsInput.value);
  if(!grams && !servings){
    alert('Please enter grams OR servings (grams preferred).');
    return;
  }
  // if user provided servings, try to guess grams per serving (simple fallback: 100g)
  // Better: you could maintain a per-food "gramsPerServing" table.
  let totalGrams = grams;
  if(!totalGrams && servings){
    totalGrams = servings * 100; // default 100 g per serving (approx)
  }
  const nut = NUTRITION_DB[selected] || NUTRITION_DB['unknown'];
  const factor = totalGrams / 100;
  const cal = Math.round(nut.cal * factor);
  const protein = +(nut.protein * factor).toFixed(1);
  const fat = +(nut.fat * factor).toFixed(1);
  out.style.display = 'block';
  out.innerHTML = `
    <strong>Food:</strong> ${selected}<br>
    <strong>Portion:</strong> ${totalGrams} g<br>
    <strong>Estimated energy:</strong> ${cal} kcal<br>
    <strong>Protein:</strong> ${protein} g<br>
    <strong>Fat:</strong> ${fat} g
  `;
});

/* accessibility: if someone chooses different food, hide model suggestion? */
foodSelect.addEventListener('change', ()=>{ /* no-op for now */ });

</script>
</body>
</html>
